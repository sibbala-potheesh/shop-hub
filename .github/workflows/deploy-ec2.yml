name: Deploy to EC2

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      FRONTEND_DIR: app
      BACKEND_DIR: api

    steps:
      - name: "üì• Checkout repo"
        uses: actions/checkout@v4

      - name: "üîç Log: Node & npm version before setup"
        run: |
          echo "üîé Checking Node version before setup..."
          node -v || echo "‚ùå Node not installed"
          echo "üîé Checking npm version before setup..."
          npm -v || echo "‚ùå npm not installed"

      - name: "üü¶ Setup Node.js (v20)"
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: "üîç Log: Node & npm version after setup"
        run: |
          echo "üü¢ Node version after setup:"
          node -v
          echo "üü¢ npm version after setup:"
          npm -v

      - name: "üì¶ Install root dependencies"
        run: |
          echo "üì¶ Running npm ci (root)..."
          npm ci
          echo "‚úÖ npm ci root complete"

      - name: "üì¶ Show installed packages (root)"
        run: |
          echo "üìã Installed packages summary (root):"
          npm ls --depth=1 || true

      - name: "üóúÔ∏è Create deployment zip"
        run: |
          echo "üóúÔ∏è Creating deployment zip..."
          node scripts/create-deployment-zip.js
          echo "üì¶ Deployment zip created:"
          ls -lh *.zip || echo "‚ö†Ô∏è No zip found"

      - name: "üîê Optional: Configure AWS credentials (for resolving EC2 IP)"
        if: ${{ secrets.AWS_ACCESS_KEY_ID && secrets.AWS_SECRET_ACCESS_KEY && secrets.EC2_INSTANCE_ID }}
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: "üîé Optional: Resolve EC2 public IP from instance id"
        if: ${{ secrets.AWS_ACCESS_KEY_ID && secrets.AWS_SECRET_ACCESS_KEY && secrets.EC2_INSTANCE_ID }}
        run: |
          echo "üîß Installing awscli..."
          sudo apt-get update -y
          sudo apt-get install -y awscli jq
          echo "üîé Resolving public IP for instance ${{ secrets.EC2_INSTANCE_ID }}..."
          IP=$(aws ec2 describe-instances --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" --query "Reservations[].Instances[].PublicIpAddress" --output text)
          if [ -z "$IP" ] || [ "$IP" = "None" ]; then
            echo "‚ùå Could not resolve public IP for instance ${{ secrets.EC2_INSTANCE_ID }}"
            exit 1
          fi
          echo "‚úÖ Resolved EC2 public IP: $IP"
          echo "EC2_HOST=$IP" >> $GITHUB_ENV

      - name: "üîê Prepare SSH key"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          EC2_HOST: ${{ env.EC2_HOST || secrets.EC2_HOST }}
        run: |
          set -e
          echo "üîê Preparing SSH key..."
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "‚ùå SSH_PRIVATE_KEY secret is missing"
            exit 1
          fi
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          if [ -z "${EC2_HOST}" ]; then
            echo "‚ùå EC2 host not provided. Set secret EC2_HOST or EC2_INSTANCE_ID."
            exit 1
          fi
          echo "üîë Adding EC2 host to known_hosts..."
          ssh-keyscan -H "${EC2_HOST}" >> ~/.ssh/known_hosts || true
          chmod 644 ~/.ssh/known_hosts
          echo "‚úÖ SSH key setup complete. EC2_HOST=${EC2_HOST}"

      - name: "üì§ Upload deployment zip to EC2"
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ env.EC2_HOST || secrets.EC2_HOST }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
        run: |
          set -e
          echo "üì§ Uploading deployment zip to EC2..."
          ZIP=$(ls *.zip | head -n1)
          if [ -z "$ZIP" ]; then
            echo "‚ùå No deployment zip found"
            exit 1
          fi
          echo "üì¶ Uploading $ZIP to ${EC2_USER}@${EC2_HOST}:${REMOTE_DIR:-/home/${EC2_USER}}/"
          scp -o StrictHostKeyChecking=no "$ZIP" "${EC2_USER}@${EC2_HOST}:${REMOTE_DIR:-/home/${EC2_USER}}/"
          echo "‚úÖ Upload complete: $ZIP"

      - name: "üöÄ Remote unzip, install and start"
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ env.EC2_HOST || secrets.EC2_HOST }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
        run: |
          set -e
          echo "üöÄ Connecting to EC2 and running remote deploy steps..."
          ssh -o StrictHostKeyChecking=no "${EC2_USER}@${EC2_HOST}" << 'EOF'
            set -e
            echo "üìÅ Setting up remote directory..."
            REMOTE_DIR="${REMOTE_DIR:-/home/${EC2_USER}}"
            mkdir -p "$REMOTE_DIR"
            cd "$REMOTE_DIR"
            echo "üîç Checking for unzip..."
            if ! command -v unzip >/dev/null 2>&1 ; then
              echo "üì¶ Installing unzip..."
              if command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update && sudo apt-get install -y unzip
              elif command -v yum >/dev/null 2>&1; then
                sudo yum install -y unzip
              fi
            fi
            echo "üóúÔ∏è Unzipping deployment package..."
            unzip -o *.zip -d .
            if [ -f package.json ]; then
              echo "üì¶ Installing production dependencies..."
              npm install --production
            fi
            echo "üõë Stopping old process (if any)..."
            pkill -f "node dist/main.js" || echo "‚ÑπÔ∏è No old process running."
            echo "üöÄ Starting application..."
            nohup node dist/main.js > app.log 2>&1 &
            sleep 1
            echo "üìÑ Last 50 log lines:"
            tail -n 50 app.log || echo "‚ö†Ô∏è No logs yet"
          EOF
          echo "‚úÖ Remote deploy finished!"
