name: Deploy to EC2 (SSH)

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      FRONTEND_DIR: app
      BACKEND_DIR: api

    steps:
      - name: "üì• Checkout repo"
        uses: actions/checkout@v4

      - name: "üîç Node & npm version (before)"
        run: |
          echo "üîé Node before setup:"
          node -v || echo "‚ùå Node not installed"
          echo "üîé npm before setup:"
          npm -v || echo "‚ùå npm not installed"

      - name: "üü¶ Setup Node.js (v20)"
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: "üîç Node & npm version (after)"
        run: |
          echo "üü¢ Node after setup:"
          node -v
          echo "üü¢ npm after setup:"
          npm -v

      - name: "üì¶ Install root dependencies"
        run: |
          echo "üì¶ Running npm ci (root)..."
          npm ci
          echo "‚úÖ npm ci root complete"

      - name: "üóúÔ∏è Create deployment zip"
        run: |
          echo "üóúÔ∏è Creating deployment zip..."
          node scripts/create-deployment-zip.js
          ZIP=$(ls *.zip | head -n1 || true)
          if [ -z "$ZIP" ]; then
            echo "‚ùå No zip produced by create-deployment-zip.js"
            exit 1
          fi
          echo "‚úÖ Created $ZIP"
          echo "ZIP_NAME=$ZIP" >> $GITHUB_ENV

      # Use ssh-agent action to safely add the key into an agent
      - name: "üîê Start ssh-agent and add key"
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # Prepare known_hosts and show local ~/.ssh for debugging
      - name: "üîê Prepare known_hosts & show SSH dir"
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "üîë Adding EC2_HOST to known_hosts (ssh-keyscan)..."
          if [ -n "${EC2_HOST:-}" ]; then
            ssh-keyscan -H "${EC2_HOST}" >> ~/.ssh/known_hosts || true
          else
            echo "‚ùå EC2_HOST secret is missing"
            exit 1
          fi
          chmod 644 ~/.ssh/known_hosts
          echo "üóíÔ∏è ~/.ssh listing:"
          ls -la ~/.ssh || true
          echo "üóíÔ∏è known_hosts (first 5 lines):"
          head -n 5 ~/.ssh/known_hosts || true

      # Compute fingerprint from private key (derived public) ‚Äî will fail if private-key format is wrong
      - name: "üîç Debug: fingerprint of SSH_PRIVATE_KEY (derived public)"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          TMP=/tmp/id_rsa_for_fp
          printf "%s\n" "$SSH_PRIVATE_KEY" > "$TMP"
          chmod 600 "$TMP"
          if ssh-keygen -y -f "$TMP" > "${TMP}.pub" 2>/dev/null; then
            echo "Fingerprint of derived public key (from secret):"
            ssh-keygen -lf "${TMP}.pub" || true
          else
            echo "‚ùå Failed to derive public key from private key. Check private key format (header/footer, CRLF, etc.)"
            rm -f "$TMP" "${TMP}.pub" || true
            exit 1
          fi
          rm -f "$TMP" "${TMP}.pub"

      # Attempt to read remote authorized_keys (best-effort; may fail when auth fails)
      - name: "üîé Remote: attempt to list remote authorized_keys (best-effort)"
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          set -euo pipefail
          echo "Attempting to read remote ~/.ssh/authorized_keys (may fail if auth not working)..."
          ssh -o StrictHostKeyChecking=no -o IdentitiesOnly=yes "${EC2_USER}@${EC2_HOST}" \
              'awk '\''{for(i=1;i<=NF;i++) if ($i ~ /^(ssh-|ecdsa-|sk-|ed25519-)/) {print $i" "$(i+1); break}}'\'' ~/.ssh/authorized_keys' \
            || echo "‚ö†Ô∏è Could not read remote authorized_keys (this is expected if auth fails)"

      # Verbose SSH debug ‚Äî shows which username is attempted and which keys the client offers
      - name: "üîé SSH debug - verbose (will show auth negotiation)"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          set -euo pipefail
          # write the key to disk for ssh -i; ssh-agent already has it but this helps IdentitiesOnly tests
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa_debug
          chmod 600 ~/.ssh/id_rsa_debug
          echo "Running ssh -vvv to see auth negotiation (this shows attempted username & keys tried):"
          ssh -i ~/.ssh/id_rsa_debug -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -vvv "${EC2_USER}@${EC2_HOST}" "echo CONNECTED" || echo "SSH debug ended with non-zero exit (expected if auth fails)"

      # Upload the zip using scp (ssh-agent supplies key)
      - name: "üì§ Upload deployment zip to EC2"
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
        run: |
          set -euo pipefail
          echo "üì§ Uploading deployment zip to EC2..."
          ZIP="${{ env.ZIP_NAME }}"
          if [ -z "$ZIP" ]; then
            ZIP=$(ls *.zip | head -n1 || true)
          fi
          if [ -z "$ZIP" ]; then
            echo "‚ùå No zip found to upload"
            exit 1
          fi
          TARGET_DIR="${REMOTE_DIR:-/home/${EC2_USER}}"
          echo "üì¶ Uploading $ZIP to ${EC2_USER}@${EC2_HOST}:${TARGET_DIR}/"
          # Use scp; ssh-agent provides the identity so no private key file must be committed
          scp -o StrictHostKeyChecking=no -o IdentitiesOnly=yes "$ZIP" "${EC2_USER}@${EC2_HOST}:${TARGET_DIR}/"
          echo "‚úÖ Upload complete: $ZIP"

      - name: "üöÄ Remote unzip, install and start"
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
        run: |
          set -euo pipefail
          echo "üöÄ Connecting to EC2 and running remote deploy steps..."
          ssh -o StrictHostKeyChecking=no -o IdentitiesOnly=yes "${EC2_USER}@${EC2_HOST}" << 'EOF'
            set -e
            echo "üìÅ Ensuring remote directory exists..."
            REMOTE_DIR="${REMOTE_DIR:-/home/${EC2_USER}}"
            mkdir -p "$REMOTE_DIR"
            cd "$REMOTE_DIR"
            echo "üîç Checking for unzip..."
            if ! command -v unzip >/dev/null 2>&1 ; then
              echo "üì¶ Installing unzip..."
              if command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update && sudo apt-get install -y unzip
              elif command -v yum >/dev/null 2>&1; then
                sudo yum install -y unzip
              fi
            fi
            echo "üóúÔ∏è Unzipping deployment package..."
            unzip -o *.zip -d .
            if [ -f package.json ]; then
              echo "üì¶ Installing production dependencies..."
              npm install --production
            fi
            echo "üõë Stopping old process (if any)..."
            pkill -f "node dist/main.js" || echo "‚ÑπÔ∏è No old process running."
            echo "üöÄ Starting application..."
            nohup node dist/main.js > app.log 2>&1 &
            sleep 1
            echo "üìÑ Last 50 log lines:"
            tail -n 50 app.log || echo "‚ö†Ô∏è No logs yet"
          EOF
          echo "‚úÖ Remote deploy finished!"
