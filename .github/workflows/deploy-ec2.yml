name: Deploy to EC2 (SSH)

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      FRONTEND_DIR: app
      BACKEND_DIR: api

    steps:
      - name: "üì• Checkout repo"
        uses: actions/checkout@v4

      - name: "üîç Node & npm version (before)"
        run: |
          echo "üîé Node before setup:"
          node -v || echo "‚ùå Node not installed"
          echo "üîé npm before setup:"
          npm -v || echo "‚ùå npm not installed"

      - name: "üü¶ Setup Node.js (v20)"
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: "üîç Node & npm version (after)"
        run: |
          echo "üü¢ Node after setup:"
          node -v
          echo "üü¢ npm after setup:"
          npm -v

      - name: "üì¶ Install root dependencies"
        run: |
          echo "üì¶ Running npm ci (root)..."
          npm ci
          echo "‚úÖ npm ci root complete"

      - name: "üóúÔ∏è Create deployment zip"
        run: |
          echo "üóúÔ∏è Creating deployment zip..."
          node scripts/create-deployment-zip.js
          ZIP=$(ls *.zip | head -n1 || true)
          if [ -z "$ZIP" ]; then
            echo "‚ùå No zip produced by create-deployment-zip.js"
            exit 1
          fi
          echo "‚úÖ Created $ZIP"
          echo "ZIP_NAME=$ZIP" >> $GITHUB_ENV

      - name: "üîê Prepare SSH key"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          set -e
          echo "üîê Preparing SSH key..."
          if [ -z "${SSH_PRIVATE_KEY}" ]; then
            echo "‚ùå SSH_PRIVATE_KEY secret is missing"
            exit 1
          fi
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          if [ -z "${EC2_HOST}" ]; then
            echo "‚ùå EC2_HOST secret is missing"
            exit 1
          fi
          echo "üîë Adding EC2 host to known_hosts..."
          ssh-keyscan -H "${EC2_HOST}" >> ~/.ssh/known_hosts || true
          chmod 644 ~/.ssh/known_hosts
          echo "‚úÖ SSH key ready. EC2_HOST=${EC2_HOST}"

      - name: "üì§ Upload deployment zip to EC2"
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
        run: |
          set -e
          echo "üì§ Uploading deployment zip to EC2..."
          ZIP="${{ env.ZIP_NAME }}"
          if [ -z "$ZIP" ]; then
            ZIP=$(ls *.zip | head -n1 || true)
          fi
          if [ -z "$ZIP" ]; then
            echo "‚ùå No zip found to upload"
            exit 1
          fi
          echo "üì¶ Uploading $ZIP to ${EC2_USER}@${EC2_HOST}:${REMOTE_DIR:-/home/${EC2_USER}}/"
          scp -o StrictHostKeyChecking=no "$ZIP" "${EC2_USER}@${EC2_HOST}:${REMOTE_DIR:-/home/${EC2_USER}}/"
          echo "‚úÖ Upload complete: $ZIP"

      - name: "üöÄ Remote unzip, install and start"
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
        run: |
          set -e
          echo "üöÄ Connecting to EC2 and running remote deploy steps..."
          ssh -o StrictHostKeyChecking=no "${EC2_USER}@${EC2_HOST}" << 'EOF'
            set -e
            echo "üìÅ Ensuring remote directory exists..."
            REMOTE_DIR="${REMOTE_DIR:-/home/${EC2_USER}}"
            mkdir -p "$REMOTE_DIR"
            cd "$REMOTE_DIR"
            echo "üîç Checking for unzip..."
            if ! command -v unzip >/dev/null 2>&1 ; then
              echo "üì¶ Installing unzip..."
              if command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update && sudo apt-get install -y unzip
              elif command -v yum >/dev/null 2>&1; then
                sudo yum install -y unzip
              fi
            fi
            echo "üóúÔ∏è Unzipping deployment package..."
            unzip -o *.zip -d .
            if [ -f package.json ]; then
              echo "üì¶ Installing production dependencies..."
              npm install --production
            fi
            echo "üõë Stopping old process (if any)..."
            pkill -f "node dist/main.js" || echo "‚ÑπÔ∏è No old process running."
            echo "üöÄ Starting application..."
            nohup node dist/main.js > app.log 2>&1 &
            sleep 1
            echo "üìÑ Last 50 log lines:"
            tail -n 50 app.log || echo "‚ö†Ô∏è No logs yet"
          EOF
          echo "‚úÖ Remote deploy finished!"
